---
- name: Install Docker
  apt:
    name: docker.io
    state: present
    update_cache: yes

- name: Install Docker Compose
  shell: |
    curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    chmod +x /usr/local/bin/docker-compose

- name: Start Docker service
  service:
    name: docker
    state: started
    enabled: yes

- name: Create workspace directory
  file:
    path: /workspaces/backend
    state: directory
    mode: '0755'

- name: Login to Amazon ECR
  shell: |
    aws ecr get-login-password --region {{ aws_region }} | docker login --username AWS --password-stdin {{ ssm_parameters.ecr_backend_image.split('/')[0] }}
  environment:
    AWS_REGION: "{{ aws_region }}"
    AWS_DEFAULT_REGION: "{{ aws_region }}"

- name: Generate docker-compose.yml from template
  template:
    src: docker-compose.yml.j2
    dest: /workspaces/backend/docker-compose.yml
    mode: '0644'
  vars:
    ecr_backend_image: "{{ ssm_parameters.ecr_backend_image }}"

- name: Stop existing containers
  shell: |
    cd /workspaces/backend
    docker-compose down || true

- name: Start backend services
  shell: |
    cd /workspaces/backend
    docker-compose up -d

- name: Wait for services to be ready
  pause:
    seconds: 30
