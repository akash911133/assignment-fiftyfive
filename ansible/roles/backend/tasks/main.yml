---
# Uses group_vars/backend.yml: app_workspace, ecr_image_var, ssm_parameters_to_fetch
# Common role must run first (sets ssm_parameters).
- name: Ensure Docker is installed and running
  include_role:
    name: docker

- name: Create app workspace directory
  file:
    path: "{{ app_workspace }}"
    state: directory
    mode: '0755'

- name: Login to Amazon ECR
  shell: |
    aws ecr get-login-password --region {{ aws_region }} | docker login --username AWS --password-stdin {{ (ssm_parameters[ecr_image_var]).split('/')[0] }}
  environment:
    AWS_REGION: "{{ aws_region }}"
    AWS_DEFAULT_REGION: "{{ aws_region }}"

- name: Generate docker-compose.yml from template
  template:
    src: docker-compose.yml.j2
    dest: "{{ app_workspace }}/docker-compose.yml"
    mode: '0644'

- name: Stop existing containers
  shell: "docker-compose down || true"
  args:
    chdir: "{{ app_workspace }}"

- name: Start backend services
  shell: "docker-compose up -d"
  args:
    chdir: "{{ app_workspace }}"

- name: Wait for services to be ready
  pause:
    seconds: "{{ app_ready_wait_seconds | default(30) }}"
